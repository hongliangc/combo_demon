# ä¼šè¯æ—¥å¿— - 2026-02-08

## ğŸ¯ æœ¬æ¬¡ç›®æ ‡
- [x] ä¿®å¤ hahashin æ”»å‡» dinosaur æ—¶ä¸è§¦å‘ stun æ•ˆæœ
- [x] ä¿®å¤ dinosaur è´´èº«åº”ä» idle ç›´æ¥æ”»å‡»ï¼Œè€Œéå…ˆ chase(run) å†æ”»å‡»
- [x] ä¿®å¤ stun åŠ¨ç”»ä¸æ’­æ”¾ï¼ˆAnimationTree ç»“æ„ç¼ºé™·ï¼‰
- [x] ä¿®å¤ stun åŠ¨ç”»åªæ’­æ”¾ä¸€æ¬¡ï¼Œåç»­ä¸å†æ’­æ”¾
- [ ] ä¿®å¤ stun åŠ¨ç”» Blend2 æ–¹æ¡ˆä¸‹ä»ä¸æ’­æ”¾ï¼ˆè°ƒæŸ¥ä¸­ï¼‰

---

## ğŸ“ å®Œæˆå†…å®¹

### é—®é¢˜1: Stun æ•ˆæœä¸è§¦å‘

**é—®é¢˜æè¿°**: hahashin ä½¿ç”¨ X æ™®é€šæ”»å‡» dinosaur æ—¶ï¼Œdinosaur æ²¡æœ‰è¿›å…¥ stun çŠ¶æ€ã€‚

**æ’æŸ¥è¿‡ç¨‹**:
1. è¿½è¸ªå®Œæ•´çš„æ”»å‡»â†’ä¼¤å®³â†’æ•ˆæœé“¾ï¼š
   - Player X æ”»å‡» â†’ CombatComponent â†’ Physical.tres (å« StunEffect)
   - Hitbox â†’ Hurtbox â†’ HealthComponent.take_damage()
   - apply_attack_effects() â†’ StunEffect.apply_effect()
   - damaged.emit() â†’ BaseStateMachine._on_owner_damaged() â†’ on_damaged()
2. Physical.tres ç¡®è®¤åŒ…å« StunEffectï¼ˆstun_duration=1.5sï¼‰
3. å‘ç° StunEffect.apply_effect() çš„è½¬æ¢é€»è¾‘æœ‰è¯¯

**æ ¹æœ¬åŸå› **: StunEffect è°ƒç”¨äº†ä¸å­˜åœ¨çš„ `state_machine.transition("stun")` æ–¹æ³•

è¯¦ç»†åˆ†æ:
- `BaseStateMachine` æ²¡æœ‰ `transition()` æ–¹æ³•ï¼Œåªæœ‰ `force_transition()`
- `has_method("transition")` è¿”å› falseï¼Œè¿›å…¥ else åˆ†æ”¯
- else åˆ†æ”¯æ‰§è¡Œ `stun_state.transitioned.emit(stun_state, "stun")`
- `_on_state_transition` æ£€æŸ¥ `from_state != current_state` â†’ stun_state != idle_state â†’ **æ‹’ç»è½¬æ¢**

```
StunEffect.apply_effect()
  â”œâ”€ state_machine.transition("stun")    â†’ æ–¹æ³•ä¸å­˜åœ¨ âœ—
  â””â”€ stun_state.transitioned.emit(...)   â†’ from_state ä¸åŒ¹é…ï¼Œè¢«æ‹’ç» âœ—
```

**è§£å†³æ–¹æ¡ˆ**: ä¿®æ”¹ [StunEffect.gd:35-37](../../Core/Resources/StunEffect.gd#L35-L37)

```diff
-		# è½¬æ¢åˆ° stun çŠ¶æ€
-		if state_machine.has_method("transition"):
-			state_machine.transition("stun")
-		else:
-			# å¦‚æœæ²¡æœ‰ transition æ–¹æ³•ï¼Œå°è¯•é€šè¿‡çŠ¶æ€çš„ transitioned ä¿¡å·
-			if stun_state:
-				stun_state.transitioned.emit(stun_state, "stun")
+		# å¼ºåˆ¶è½¬æ¢åˆ° stun çŠ¶æ€ï¼ˆä½¿ç”¨ force_transition å¿½ç•¥ä¼˜å…ˆçº§æ£€æŸ¥ï¼‰
+		if state_machine.has_method("force_transition"):
+			state_machine.force_transition("stun")
```

**è®¾è®¡è¯´æ˜**:
- `force_transition` åœ¨ `BaseStateMachine` ä¸­å­˜åœ¨ï¼Œè·³è¿‡ä¼˜å…ˆçº§æ£€æŸ¥ç›´æ¥æ‰§è¡Œè½¬æ¢
- StunEffect æ˜¯æ§åˆ¶å±‚æ•ˆæœï¼Œåº”è¯¥æ— æ¡ä»¶ç”Ÿæ•ˆï¼Œä½¿ç”¨ force_transition ç¬¦åˆè®¾è®¡æ„å›¾

---

### é—®é¢˜2: Dinosaur è´´èº«æ—¶å…ˆ chase å†æ”»å‡»

**é—®é¢˜æè¿°**: å½“ç©å®¶å·²ç»åœ¨ dinosaur æ”»å‡»èŒƒå›´å†…æ—¶ï¼Œdinosaur ä»ç„¶å…ˆè¿›å…¥ chaseï¼ˆæ’­æ”¾ run åŠ¨ç”»ï¼‰ï¼Œé è¿‘åæ‰è½¬ä¸º attackã€‚åº”è¯¥ä» idle ç›´æ¥è¿›å…¥ attackã€‚

**æ’æŸ¥è¿‡ç¨‹**:
1. åˆ†æ IdleState.process_state() é€»è¾‘ â†’ åªè°ƒç”¨ `try_chase()`
2. `try_chase()` æ£€æŸ¥ `detection_radius`ï¼ŒèŒƒå›´å†…ä¸€å¾‹è½¬ chase
3. æ²¡æœ‰æ”»å‡»èŒƒå›´æ£€æµ‹ï¼Œæ— æ³•è·³è¿‡ chase ç›´æ¥è¿›å…¥ attack

**æ ¹æœ¬åŸå› **: IdleState çš„çŠ¶æ€æ£€æµ‹åªæœ‰ chase è·¯å¾„ï¼Œæ²¡æœ‰ attack è·¯å¾„

çŠ¶æ€æµï¼ˆä¿®å¤å‰ï¼‰:
```
Idle â†’ Chase (detection_radius=100) â†’ Attack (follow_radius=25)
```
å³ä½¿ç©å®¶å°±åœ¨æ—è¾¹ï¼ˆè·ç¦» < 25ï¼‰ï¼Œä¹Ÿå¿…é¡»ç»è¿‡ Chaseã€‚

**è§£å†³æ–¹æ¡ˆ**:

1. åœ¨ [BaseState.gd:109-118](../../Core/StateMachine/BaseState.gd#L109-L118) æ–°å¢ `try_attack()` æ–¹æ³•:

```diff
+## å°è¯•è½¬æ¢åˆ°æ”»å‡»çŠ¶æ€ï¼ˆå½“ç›®æ ‡åœ¨æ”»å‡»èŒƒå›´å†…æ—¶è·³è¿‡è¿½å‡»ï¼‰
+func try_attack(radius: float = -1.0) -> bool:
+	var effective_radius = radius if radius > 0 else get_owner_property("follow_radius", -1.0)
+	if effective_radius <= 0:
+		return false
+	if is_target_alive() and get_distance_to_target() <= effective_radius:
+		if state_machine and state_machine.states.has("attack"):
+			transitioned.emit(self, "attack")
+			return true
+	return false
```

2. åœ¨ [IdleState.gd:71-75](../../Core/StateMachine/CommonStates/IdleState.gd#L71-L75) ä¼˜å…ˆæ£€æŸ¥æ”»å‡»èŒƒå›´:

```diff
 func process_state(_delta: float) -> void:
 	# æ£€æµ‹ç©å®¶
 	if enable_player_detection:
+		# ä¼˜å…ˆæ£€æŸ¥æ”»å‡»èŒƒå›´ï¼šåœ¨æ”»å‡»èŒƒå›´å†…ç›´æ¥è¿›å…¥æ”»å‡»ï¼Œè·³è¿‡è¿½å‡»
+		if try_attack():
+			return
 		if try_chase():
 			return
```

çŠ¶æ€æµï¼ˆä¿®å¤åï¼‰:
```
Idle â†’ Attack  (è·ç¦» <= follow_radius)
Idle â†’ Chase   (è·ç¦» <= detection_radius ä¸” > follow_radius)
```

---

### é—®é¢˜3: Stun åŠ¨ç”»ä¸æ’­æ”¾

**é—®é¢˜æè¿°**: dinosaur è¢«æ”»å‡»åè¿›å…¥ stun çŠ¶æ€ï¼ˆåœæ­¢ç§»åŠ¨ï¼‰ï¼Œä½† stunned åŠ¨ç”»ä¸æ’­æ”¾ã€‚

**æ’æŸ¥è¿‡ç¨‹**:
1. StunState.enter() è°ƒç”¨ `enter_control_state("stunned")`
2. `enter_control_state` è®¾ç½® `parameters/control_sm/playback` å’Œ `parameters/output/blend_amount`
3. æ£€æŸ¥ dinosaur.tscn çš„ AnimationTree BlendTree ç»“æ„:
   ```
   node_connections = [&"output", 0, &"locomotion"]
   ```
4. å‘ç° `control_sm` èŠ‚ç‚¹ï¼ˆå« stunned/hit/death åŠ¨ç”»ï¼‰**å®Œå…¨æ²¡æœ‰è¿æ¥åˆ° output**

**æ ¹æœ¬åŸå› **: AnimationTree çš„ BlendTree ä¸­ control_sm æ˜¯å­¤ç«‹èŠ‚ç‚¹

```
ä¿®å¤å‰çš„ BlendTree ç»“æ„:
  locomotion â”€â”€â†’ output
  control_sm     (å­¤ç«‹ï¼Œæœªè¿æ¥)

ä¿®å¤åçš„ BlendTree ç»“æ„:
  locomotion â”€â”€â”
               â”œâ”€ control_blend (Blend2) â”€â”€â†’ output
  control_sm â”€â”€â”˜
```

å¦å¤–ï¼Œ`enter_control_state()` è®¾ç½® `parameters/output/blend_amount`ï¼Œä½† output æ˜¯ AnimationNodeOutput ç±»å‹ï¼Œæ²¡æœ‰ blend_amount å±æ€§ï¼Œè®¾ç½®æ— æ•ˆã€‚

**è§£å†³æ–¹æ¡ˆ**:

1. åœ¨ [dinosaur.tscn](../../Scenes/Characters/Enemies/dinosaur/dinosaur.tscn) æ·»åŠ  AnimationNodeBlend2 å¹¶ä¿®å¤è¿æ¥:

```diff
+[sub_resource type="AnimationNodeBlend2" id="AnimationNodeBlend2_control"]
+
 [sub_resource type="AnimationNodeBlendTree" id="AnimationNodeBlendTree_root"]
+nodes/control_blend/node = SubResource("AnimationNodeBlend2_control")
+nodes/control_blend/position = Vector2(360, 340)
-node_connections = [&"output", 0, &"locomotion"]
+node_connections = [&"control_blend", 0, &"locomotion", &"control_blend", 1, &"control_sm", &"output", 0, &"control_blend"]
```

AnimationTree èŠ‚ç‚¹æ·»åŠ åˆå§‹å‚æ•°:
```diff
+parameters/control_blend/blend_amount = 0.0
```

2. åœ¨ [BaseState.gd:378-395](../../Core/StateMachine/BaseState.gd#L378-L395) ä¿®æ”¹å‚æ•°è·¯å¾„:

```diff
 func enter_control_state(state_name: String) -> void:
 	var tree = get_anim_tree()
 	if tree:
-		var playback = tree.get("parameters/control_sm/playback")
-		if playback:
-			playback.travel(state_name)
-		tree.set("parameters/output/blend_amount", 1.0)
+		# å…ˆæ¿€æ´» control_blendï¼Œç¡®ä¿ control_sm è¢«å¤„ç†
+		tree.set("parameters/control_blend/blend_amount", 1.0)
+		# å†å¯åŠ¨ control_sm çš„åŠ¨ç”»æ’­æ”¾
+		var playback = tree.get("parameters/control_sm/playback")
+		if playback:
+			playback.start(state_name, true)

 func exit_control_state() -> void:
 	var tree = get_anim_tree()
 	if tree:
-		tree.set("parameters/output/blend_amount", 0.0)
+		tree.set("parameters/control_blend/blend_amount", 0.0)
```

---

### é—®é¢˜4: Stun åŠ¨ç”»åªæ’­æ”¾ä¸€æ¬¡

**é—®é¢˜æè¿°**: ç¬¬ä¸€æ¬¡æ”»å‡» dinosaur æ—¶ stun åŠ¨ç”»æ­£å¸¸æ’­æ”¾ï¼Œä½†åç»­æ”»å‡»éƒ½ä¸å†æ’­æ”¾åŠ¨ç”»ã€‚

**æ ¹æœ¬åŸå› **: `playback.travel("stunned")` åœ¨å·²å¤„äº "stunned" çŠ¶æ€æ—¶ä¸ä¼šé‡æ–°æ’­æ”¾

- ç¬¬ä¸€æ¬¡ stun: control_sm ä»åˆå§‹çŠ¶æ€ travel åˆ° "stunned" â†’ åŠ¨ç”»æ’­æ”¾
- stun ç»“æŸ: `exit_control_state()` è®¾ç½® blend_amount=0.0ï¼Œä½† control_sm å†…éƒ¨ä»åœåœ¨ "stunned"
- ç¬¬äºŒæ¬¡ stun: `travel("stunned")` å‘ç°å·²åœ¨ "stunned" â†’ ä¸åšä»»ä½•äº‹ â†’ åŠ¨ç”»ä¸æ’­æ”¾

**è§£å†³æ–¹æ¡ˆ**: ä¿®æ”¹ [BaseState.gd:385](../../Core/StateMachine/BaseState.gd#L385)

```diff
-			playback.travel(state_name)
+			playback.start(state_name, true)
```

`start(state_name, true)` çš„ `reset=true` å‚æ•°ä¼šå¼ºåˆ¶ä»å¤´å¼€å§‹æ’­æ”¾ï¼Œä¸ç®¡å½“å‰å¤„äºä»€ä¹ˆçŠ¶æ€ã€‚

---

### é—®é¢˜5: Stunned åŠ¨ç”»ä¸å¾ªç¯

**é—®é¢˜æè¿°**: stunned åŠ¨ç”»æ—¶é•¿ 0.8 ç§’ï¼Œä½† stun æŒç»­ 1.5 ç§’ã€‚åŠ¨ç”»æ’­æ”¾ä¸€æ¬¡ååœæ­¢ï¼Œå‰©ä½™ 0.7 ç§’æ˜¯é™æ­¢ç”»é¢ã€‚

**è§£å†³æ–¹æ¡ˆ**: ä¿®æ”¹ [dinosaur.tscn](../../Scenes/Characters/Enemies/dinosaur/dinosaur.tscn) stunned åŠ¨ç”»èµ„æº

```diff
 [sub_resource type="Animation" id="Animation_4vyqg"]
 resource_name = "stunned"
+loop_mode = 1
 step = 0.05
```

---

### é—®é¢˜6: Blend2 æ–¹æ¡ˆä¸‹ control_sm ä¸å¤„ç†ï¼ˆè¿›è¡Œä¸­ï¼‰

**é—®é¢˜æè¿°**: å³ä½¿ Blend2 è¿æ¥æ­£ç¡®ï¼Œstun åŠ¨ç”»å¯èƒ½ä»ä¸æ’­æ”¾ã€‚

**åˆ†æ**: å½“ `control_blend/blend_amount = 0.0` æ—¶ï¼ŒGodot å¯èƒ½è·³è¿‡å¤„ç† input 1ï¼ˆcontrol_smï¼‰ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚æ­¤æ—¶è°ƒç”¨ `playback.start()` å¯èƒ½è¢«å¿½ç•¥ã€‚

**å·²å°è¯•çš„ä¿®å¤**: è°ƒæ¢æ“ä½œé¡ºåº â€” å…ˆè®¾ blend_amount=1.0 æ¿€æ´»èŠ‚ç‚¹ï¼Œå†è°ƒç”¨ start()

**çŠ¶æ€**: ç­‰å¾…ç”¨æˆ·éªŒè¯

---

## ğŸ”§ ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| [StunEffect.gd](../../Core/Resources/StunEffect.gd) | ä½¿ç”¨ `force_transition` æ›¿ä»£ä¸å­˜åœ¨çš„ `transition` |
| [BaseState.gd](../../Core/StateMachine/BaseState.gd) | æ–°å¢ `try_attack()`ï¼›ä¿®å¤ `enter/exit_control_state` å‚æ•°è·¯å¾„å’Œæ“ä½œé¡ºåº |
| [IdleState.gd](../../Core/StateMachine/CommonStates/IdleState.gd) | process_state ä¸­ä¼˜å…ˆè°ƒç”¨ try_attack |
| [dinosaur.tscn](../../Scenes/Characters/Enemies/dinosaur/dinosaur.tscn) | AnimationTree æ·»åŠ  Blend2 è¿æ¥ control_smï¼›stunned åŠ¨ç”»æ·»åŠ å¾ªç¯ |

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### 1. AnimationTree BlendTree å¸¸è§é™·é˜±
- BlendTree ä¸­çš„èŠ‚ç‚¹å¿…é¡»é€šè¿‡ `node_connections` æ˜¾å¼è¿æ¥ï¼Œå¦åˆ™æ˜¯å­¤ç«‹èŠ‚ç‚¹
- `output` æ˜¯ AnimationNodeOutput ç±»å‹ï¼Œä¸æ”¯æŒ blend_amount å‚æ•°
- éœ€è¦é¢å¤–çš„ Blend2/Blend3 èŠ‚ç‚¹æ¥æ··åˆä¸åŒå±‚çº§çš„åŠ¨ç”»

### 2. AnimationNodeStateMachinePlayback API
- `travel(node)`: å¦‚æœå·²åœ¨ç›®æ ‡èŠ‚ç‚¹åˆ™ä¸åšä»»ä½•äº‹ â†’ ä¸é€‚åˆéœ€è¦é‡å¤æ’­æ”¾çš„åœºæ™¯
- `start(node, reset=true)`: å¼ºåˆ¶ä»å¤´æ’­æ”¾ â†’ é€‚åˆ stun/hit ç­‰éœ€è¦æ¯æ¬¡é‡æ–°è§¦å‘çš„çŠ¶æ€
- Blend2 ä¸­ weight=0 çš„è¾“å…¥å¯èƒ½ä¸è¢«å¤„ç† â†’ å…ˆè®¾ blend_amount å†æ“ä½œ playback

### 3. çŠ¶æ€æœºæ•ˆæœè§¦å‘è®¾è®¡
- `force_transition()` é€‚ç”¨äºå¤–éƒ¨æ•ˆæœï¼ˆStunEffectï¼‰å¼ºåˆ¶æ”¹å˜çŠ¶æ€
- `transitioned.emit(self, ...)` é€‚ç”¨äºçŠ¶æ€å†…éƒ¨è‡ªä¸»å†³ç­–è½¬æ¢
- ä¸è¦ä»éå½“å‰çŠ¶æ€çš„èŠ‚ç‚¹ emit transitioned ä¿¡å·ï¼Œä¼šè¢« `from_state != current_state` æ£€æŸ¥æ‹’ç»

### 4. Idle çŠ¶æ€çš„å¤šå±‚æ£€æµ‹æ¨¡å¼
```
process_state:
  1. try_attack()  â†’ æ”»å‡»èŒƒå›´å†…ç›´æ¥æ”»å‡»
  2. try_chase()   â†’ æ£€æµ‹èŒƒå›´å†…å¼€å§‹è¿½å‡»
  3. (è¶…æ—¶)        â†’ è½¬åˆ° wander
```
éµå¾ª"æœ€è¿‘è·ç¦»ä¼˜å…ˆ"åŸåˆ™ï¼Œé¿å…ä¸å¿…è¦çš„çŠ¶æ€è·³è½¬ã€‚
